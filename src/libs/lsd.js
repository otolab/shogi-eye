!function(t,i){"object"==typeof exports&&"object"==typeof module?module.exports=i():"function"==typeof define&&define.amd?define([],i):"object"==typeof exports?exports.lineSegmentDetector=i():t.lineSegmentDetector=i()}("undefined"!=typeof self?self:this,function(){return function(t){function i(r){if(e[r])return e[r].exports;var n=e[r]={i:r,l:!1,exports:{}};return t[r].call(n.exports,n,n.exports,i),n.l=!0,n.exports}var e={};return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:r})},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,i){return Object.prototype.hasOwnProperty.call(t,i)},i.p="",i(i.s=0)}([function(t,i,e){Object.defineProperty(i,"__esModule",{value:!0});var r=e(1),n=e(2),a=function(){function t(t,i,e,n,a,h,o,s){void 0===t&&(t=r.REFINE_NONE),void 0===i&&(i=.8),void 0===e&&(e=.6),void 0===n&&(n=2),void 0===a&&(a=22.5),void 0===h&&(h=0),void 0===o&&(o=.7),void 0===s&&(s=1024),this.refineType=t,this.scale=i,this.sigmaScale=e,this.quant=n,this.angTh=a,this.logEps=h,this.densityTh=o,this.nBins=s,this.width=0,this.height=0,this.list=[]}return t.prototype.detect=function(t){return this.image=t,this.width=t.width,this.height=t.height,this.lsd()},t.prototype.drawSegments=function(t,i,e){void 0===e&&(e="#ff0000"),t.strokeStyle=e,t.lineWidth=1,i.forEach(function(i){t.beginPath(),t.moveTo(i.x1,i.y1),t.lineTo(i.x2,i.y2),t.stroke(),t.closePath()})},t.prototype.putImageData=function(t){var i=this.imageData,e=t.createImageData(this.width,this.height),r=e.data,n=e.data.length;if(!i)throw new Error("imageData required");for(var a=0;a<n;a+=4)r[a]=r[a+1]=r[a+2]=i[a/4],r[a+3]=255;t.putImageData(e,0,0)},t.prototype.lsd=function(){if(!this.image||!this.angles)throw new Error("image and angles required");var t=[],i=Math.PI*this.angTh/180,e=this.angTh/180,a=this.quant/Math.sin(i);if(1!=this.scale){var h=this.scale<1?this.sigmaScale/this.scale:this.sigmaScale,o=Math.ceil(h*Math.sqrt(6*Math.log(10))),s=1+2*o,u=this.reshape(this.image);this.imageData=this.gaussianBlur(u,s,h),this.computeLevelLineAngles(a,this.nBins)}else this.imageData=this.reshape(this.image),this.computeLevelLineAngles(a,this.nBins);var f=5*(Math.log10(this.width)+Math.log10(this.height))/2+Math.log10(11),p=-f/Math.log10(e);this.used=new Uint8Array(this.imageData.length);for(var d=0,l=this.list.length;d<l;d++){var g=this.list[d].p;if(this.at(this.used,g)===r.NOT_USED&&this.at(this.angles,g)!==r.NOT_DEF){var v=0,y=[];if(v=this.regionGrow(this.list[d].p,y,v,i),y.length<p)continue;var c=new n.Rect;this.region2Rect(y,v,i,e,c);if(this.refineType>r.REFINE_NONE){if(!this.refine(y,v,i,e,c,this.densityTh))continue;if(this.refineType>=r.REFINE_ADV&&this.improveRect(c)<=this.logEps)continue}c.x1+=.5,c.y1+=.5,c.x2+=.5,c.y2+=.5,t.push(new n.Vec4(c.x1,c.y1,c.x2,c.y2))}}return t},t.prototype.computeLevelLineAngles=function(t,i){var e=this.imageData;if(!e)throw new Error("imageData required");var a=this.width,h=this.height;this.angles=new Float64Array(e.length),this.modgrad=new Float64Array(e.length),this.angles=this.setRow(this.angles,h-1,r.NOT_DEF),this.angles=this.setCol(this.angles,a-1,r.NOT_DEF);for(var o=-1,s=0;s<h-1;s++)for(var u=s*a,f=(s+1)*a,p=0;p<a-1;p++){var d=e[p+1+f]-e[p+u],l=e[p+1+u]-e[p+f],g=d+l,v=d-l,y=Math.sqrt((g*g+v*v)/4);this.modgrad[p+u]=y,y<=t?this.angles[p+u]=r.NOT_DEF:(this.angles[p+u]=Math.atan2(g,-v),y>o&&(o=y))}var c=[];c.length=i;var x=[];x.length=i;for(var w=0,m=o>0?(i-1)/o:0,s=0;s<h-1;s++)for(var u=s*a,p=0;p<a-1;p++){var M=Math.floor(this.modgrad[p+u]*m);x[M]?(this.list[w]=new n.CoorList,x[M]=this.list[w],x[M].next=this.list[w],w++):(this.list[w]=new n.CoorList,x[M]=c[M]=this.list[w],w++),x[M].p=new n.Point(p,s),x[M].next=null}for(var E=i-1;E>0&&!c[E];E--);var _=c[E],D=E;if(_)for(;E>0;)E--,c[E]&&(x[D].next=c[E],x[D]=x[E],D=E)},t.prototype.regionGrow=function(t,i,e,a){if(!this.used||!this.angles||!this.modgrad)throw new Error("used, angles and modgrad required");var h=new n.RegionPoint;h.x=t.x,h.y=t.y,h.used=this.at(this.used,t),e=this.at(this.angles,t),h.angle=e,h.modgrad=this.at(this.modgrad,t),h.used=r.USED,i.push(h);for(var o=Math.cos(e),s=Math.sin(e),u=0;u<i.length;u++)for(var f=i[u],p=Math.max(f.x-1,0),d=Math.min(f.x+1,this.width-1),l=Math.max(f.y-1,0),g=Math.min(f.y+1,this.height-1),v=l;v<=g;v++)for(var y=v*this.width,c=p;c<=d;c++){var x=this.used[c+y];if(x!=r.USED&&this.isAligned(c,v,e,a)){var w=this.angles[c+y];x=r.USED,this.used[c+y]=r.USED;var m=new n.RegionPoint(c,v,w,this.modgrad[c+y],x);i.push(m),o+=Math.cos(w),s+=Math.sin(w),e=Math.atan2(s,o)}}return e},t.prototype.isAligned=function(t,i,e,n){if(t<0||i<0||t>=this.width||i>=this.height)return!1;var a=this.angles[t+i*this.width];if(a===r.NOT_DEF)return!1;var h=e-a;return h<0&&(h=-h),h>r.M_3_2_PI&&(h-=r.M_2__PI)<0&&(h=-h),h<=n},t.prototype.region2Rect=function(t,i,e,r,n){for(var a=0,h=0,o=0,s=0;s<t.length;s++){var u=t[s],f=u.modgrad;a+=u.x*f,h+=u.y*f,o+=f}if(o<=0)throw new Error("weighted sum must differ from 0");a/=o,h/=o;for(var p=this.getTheta(t,a,h,i,e),d=Math.cos(p),l=Math.sin(p),g=0,v=0,y=0,c=0,s=0;s<t.length;s++){var x=t[s].x-a,w=t[s].y-h,m=x*d+w*l,M=-x*l+w*d;m>v?v=m:m<g&&(g=m),M>c?c=M:M<y&&(y=M)}n.x1=a+g*d,n.y1=h+g*l,n.x2=a+v*d,n.y2=h+v*l,n.width=c-y,n.x=a,n.y=h,n.theta=p,n.dx=d,n.dy=l,n.prec=e,n.p=r,n.width<1&&(n.width=1)},t.prototype.getTheta=function(t,i,e,n,a){for(var h=0,o=0,s=0,u=0;u<t.length;u++){var f=t[u].x,p=t[u].y,d=t[u].modgrad,l=f-i,g=p-e;h+=g*g*d,o+=l*l*d,s-=l*g*d}if(r.doubleEqual(h,0)&&r.doubleEqual(o,0)&&r.doubleEqual(s,0))throw new Error("check if inertia matrix is null");var v=.5*(h+o-Math.sqrt((h-o)*(h-o)+4*s*s)),y=Math.abs(h)>Math.abs(o)?Math.atan2(v-h,s):Math.atan2(s,v-o);return r.angleDiff(y,n)>a&&(y+=Math.PI),y},t.prototype.refine=function(t,i,e,a,h,o){var s=t.length/(r.dist(h.x1,h.y1,h.x2,h.y2)*h.width);if(s>=o)return!0;for(var u=t[0].x,f=t[0].y,p=t[0].angle,d=0,l=0,g=0,v=0;v<t.length;v++){if(t[v].used=r.NOT_USED,r.dist(u,f,t[v].x,t[v].y)<h.width){var y=t[v].angle,c=r.angleDiff(y,p);d+=c,l+=c*c,g++}var x=d/g,w=2*Math.sqrt((l-2*x*d)/g+x*x);return this.regionGrow(new n.Point(t[0].x,t[0].y),t,i,w),t.length<2?!1:(this.region2Rect(t,i,e,a,h),!((s=t.length/(r.dist(h.x1,h.y1,h.x2,h.y2)*h.width))<o)||this.reduceRegionRadius(t,i,e,a,h,s,o))}return!1},t.prototype.reduceRegionRadius=function(t,i,e,n,a,h,o){for(var s=t[0].x,u=t[0].y,f=r.distSq(s,u,a.x1,a.y1),p=r.distSq(s,u,a.x2,a.y2),d=f>p?f:p;h<o;){d*=.5625;for(var l=0;l<t.length;l++)if(r.distSq(s,u,t[l].x,t[l].y)>d){t[l].used=r.NOT_USED;var g=t[l];t[l]=t[t.length-1],t[t.length-1]=g,t.pop(),--l}if(t.length<2)return!1;this.region2Rect(t,i,e,n,a),h=t.length/(r.dist(a.x1,a.y1,a.x2,a.y2)*a.width)}return!0},t.prototype.improveRect=function(t){var i=this.rectNfa(t);if(i>this.logEps)return i;var e=new n.Rect;e.copy(t);for(var r=0;r<5;r++){e.p/=2,e.prec=e.p*Math.PI;var a=this.rectNfa(t);a>i&&(i=a,t.copy(e))}if(i>this.logEps)return i;e.copy(t);for(var r=0;r<5;r++)if(e.width-.5>=.5){e.width-=.5;var a=this.rectNfa(e);a>i&&(t.copy(e),i=a)}if(i>this.logEps)return i;e.copy(t);for(var r=0;r<5;r++)if(e.width-.5>=.5){e.x1-=.25*-e.dy,e.y1-=.25*e.dx,e.x2-=.25*-e.dy,e.y2-=.25*e.dx,e.width-=.5;var a=this.rectNfa(e);a>i&&(t.copy(e),i=a)}if(i>this.logEps)return i;e.copy(t);for(var r=0;r<5;r++)if(e.width-.5>=.5){e.p/=2,e.prec=e.p*Math.PI;var a=this.rectNfa(e);a>i&&(t.copy(e),i=a)}return i},t.prototype.rectNfa=function(t){var i=0,e=0,a=t.width/2,h=t.dy*a,o=t.dx*a,s=[new n.Edge,new n.Edge,new n.Edge,new n.Edge],u=s[0],f=s[0];s[0].p.x=t.x1-h,s[0].p.y=t.y1+o,s[1].p.x=t.x2-h,s[1].p.y=t.y2+o,s[2].p.x=t.x2+h,s[2].p.y=t.y2-o,s[3].p.x=t.x1+h,s[3].p.y=t.y1-o,s.sort(r.AsmallerB_XoverY);for(var p=1;p<4;p++)u.p.y>s[p].p.y&&(u=s[p]),f.p.y<s[p].p.y&&(f=s[p]);u.taken=!0;for(var d=null,p=0;p<4;p++)s[p].taken||(d?d.p.x>s[p].p.x&&(d=s[p]):d=s[p]);if(!d)throw new Error("leftmost error");d.taken=!0;for(var l=null,p=0;p<4;p++)s[p].taken||(l?l.p.x<s[p].p.x&&(l=s[p]):l=s[p]);if(!l)throw new Error("rightmost error");l.taken=!0;for(var g=null,p=0;p<4;p++)s[p].taken||(g?g.p.x>s[p].p.x&&(g=s[p]):g=s[p]);if(!g)throw new Error("tailp error");g.taken=!0;for(var v=u.p.y!=d.p.y?(u.p.x+d.p.x)/(u.p.y-d.p.y):0,y=d.p.y!=g.p.x?(d.p.x=g.p.x)/(d.p.y-g.p.x):0,c=u.p.y!=l.p.y?(u.p.x-l.p.x)/(u.p.y-l.p.y):0,x=l.p.y!=g.p.x?(l.p.x-g.p.x)/(l.p.y-g.p.x):0,w=v,m=c,M=u.p.x,E=u.p.x,_=u.p.y,D=f.p.y,N=_;N<=D;N++)if(!(N<0||N>=this.height)){for(var R=M;R<=E;R++)R<0||R>=this.width||(i++,this.isAligned(R,N,t.theta,t.prec)&&e++);N>=d.p.y&&(w=y),N>=l.p.y&&(m=x),M+=w,E+=m}return this.nfa(i,e,t.p)},t.prototype.nfa=function(t,i,e){var n=5*(Math.log10(this.width)+Math.log10(this.height))/2+Math.log10(11);if(0==t||0==i)return-n;if(t==i)return-n-t*Math.log10(e);var a=e/(1-e),h=t+1-r.logGamma(i+1)-r.logGamma(t-i+1)+i*Math.log(e)+(t-i)*Math.log(1-e),o=Math.exp(h);if(r.doubleEqual(o,0))return i>t*e?-h/r.M_LN10-n:-n;for(var s=o,u=i+1;u<=t;u++){var f=(t-u+1)/u,p=f*a;if(o*=p,s+=o,f<1){if(o*((1-Math.pow(p,t-u+1))/(1-p)-1)<.1*Math.abs(-Math.log10(s)-n)*s)break}}return-Math.log10(s)-n},t.prototype.gaussianBlur=function(t,i,e){var r=this.width,n=this.height,a=t,h=new ImageData(r,n),o=null,s=this.getGaussianKernel(i,e),u=(i-1)/2,f=this.reshape(h);o=new Uint8ClampedArray(f.length);for(var p=0;p<n;p++)for(var d=p*r,l=0;l<r;l++){for(var g=0,v=l+d,y=0,c=-u;c<=u;c++){var x=l+c;(x<=0||r<=x)&&(x=l);var w=x+d;g+=a[w]*s[y],y++}f[v]=g}for(var l=0;l<r;l++)for(var p=0;p<n;p++){for(var d=p*r,g=0,v=l+d,y=0,m=-u;m<=u;m++){var M=p+m,E=m*r;(M<=0||n<=M)&&(M=p,E=0);var w=v+E;g+=f[w]*s[y],y++}o[v]=g}return o},t.prototype.getGaussianKernel=function(t,i){for(var e=[],r=i>0?i:.3*(.5*(t-1)-1)+.8,n=-.5/(r*r),a=0,h=0;h<t;h++){var o=h-.5*(t-1);e[h]=Math.exp(n*o*o),a+=e[h]}a=1/a;for(var h=0;h<t;h++)e[h]*=a;return e},t.prototype.reshape=function(t){for(var i=t.data,e=new Uint8ClampedArray(i.length/4),r=e.length,n=0;n<r;n++)e[n]=i[4*n];return e},t.prototype.at=function(t,i){return t[i.x+i.y*this.width]},t.prototype.row=function(t,i){var e=i*this.width;return t.subarray(e,e+this.width)},t.prototype.setRow=function(t,i,e){for(var r=i*this.width,n=r+this.width,a=r;a<n;a++)t[a]=e;return t},t.prototype.setCol=function(t,i,e){for(var r=this.height*this.width,n=this.width,a=i;a<r;a+=n)t[a]=e;return t},t}();i.default=a},function(t,i){function e(t){for(var i=[75122.633153,80916.6278952,36308.2951477,8687.24529705,1168.92649479,83.8676043424,2.50662827511],e=(t+.5)*Math.log(t+5.5)-(t+5.5),r=0,n=0;n<7;++n)e-=Math.log(t+n),r+=i[n]*Math.pow(t,n);return e+Math.log(r)}function r(t,i){for(var e=t-i,r=Math.PI;e<=-r;)e+=s;for(;e>r;)e-=s;return e}function n(t,i){var e=r(t,i);return e>=0?e:-e}function a(t,i){if(t==i)return!0;var e=t-i,r=e>=0?e:-e,n=t>=0?t:-t,a=i>=0?i:-i,h=n>a?n:a,o=Number.MIN_VALUE;return h<o&&(h=o),r/h<=u*Number.EPSILON}function h(t,i){return t.p.x==i.p.x?Number(t.p.y<i.p.y):Number(t.p.x<i.p.x)}Object.defineProperty(i,"__esModule",{value:!0});var o=3*Math.PI/2;i.M_3_2_PI=o;var s=2*Math.PI;i.M_2__PI=s;i.M_LN10=2.302585092994046;i.NOT_DEF=-1024;i.USED=1;i.NOT_USED=0;var u=100;i.RELATIVE_ERROR_FACTOR=u;var f=Math.PI/180;i.DEG_TO_RADS=f;i.REFINE_NONE=0;i.REFINE_STD=1;i.REFINE_ADV=2;var p=function(t){return t>15?d(t):e(t)};i.logGamma=p;var d=function(t){return.918938533204673+(t-.5)*Math.log(t)-t+.5*t*Math.log(t*Math.sinh(1/t)+1/(810*Math.pow(t,6)))},l=function(t,i,e,r){return(i-t)*(i-t)+(r-e)*(r-e)};i.distSq=l;var g=function(t,i,e,r){return Math.sqrt(l(t,e,i,r))};i.dist=g,i.angleDiff=n,i.doubleEqual=a,i.AsmallerB_XoverY=h},function(t,i){Object.defineProperty(i,"__esModule",{value:!0});var e=function(){function t(t,i,e,r){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===r&&(r=0),this.x1=t,this.y1=i,this.x2=e,this.y2=r}return t}();i.Vec4=e;var r=function(){function t(t,i){void 0===t&&(t=0),void 0===i&&(i=0),this.x=t,this.y=i}return t}();i.Point=r;var n=function(){function t(){this.p=new r}return t}();i.CoorList=n;var a=function(){function t(t,i,e,r,n){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===r&&(r=0),this.x=t,this.y=i,this.angle=e,this.modgrad=r,this.used=n}return t}();i.RegionPoint=a;var h=function(){function t(t,i,e,r,n,a,h,o,s,u,f,p,d){void 0===t&&(t=0),void 0===i&&(i=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===a&&(a=0),void 0===h&&(h=0),void 0===o&&(o=0),void 0===s&&(s=0),void 0===u&&(u=0),void 0===f&&(f=0),void 0===p&&(p=0),void 0===d&&(d=0),this.x1=t,this.y1=i,this.x2=e,this.y2=r,this.width=n,this.height=a,this.x=h,this.y=o,this.theta=s,this.dx=u,this.dy=f,this.prec=p,this.p=d}return t.prototype.copy=function(t){this.x1=t.x1,this.y1=t.y1,this.x2=t.x2,this.y2=t.y2,this.width=t.width,this.height=t.height,this.x=t.x,this.y=t.y,this.theta=t.theta,this.dx=t.dx,this.dy=t.dy,this.prec=t.prec,this.p=t.p},t}();i.Rect=h;var o=function(){function t(){this.p=new r}return t}();i.Edge=o}])});
//# sourceMappingURL=lsd.js.map